I_OBJID	TYPE	HROBJID	                     	对象标识
I_BEGDA	TYPE	SY-DATUM	                     	ABAP 系统字段：应用服务器的当前日期 
I_ENDDA	TYPE	SY-DATUM	                     	ABAP 系统字段：应用服务器的当前日期 
I_PERNR	TYPE	PERSNO	                     	人员号 
I_NACHN	TYPE	NACHN	                     	姓 
I_FLAG	TYPE	STRING	                     	0:明细表1：个人汇总2：部门汇总3：年休假
 
OT_BKHZ	LIKE	ZSHR_PCZHLY_001	综合利用车间部门月度考勤汇总表

FUNCTION ZHR_PC_SSSYB_002.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  IMPORTING
*"     VALUE(I_OBJID) TYPE  HROBJID OPTIONAL
*"     VALUE(I_BEGDA) TYPE  SY-DATUM OPTIONAL
*"     VALUE(I_ENDDA) TYPE  SY-DATUM OPTIONAL
*"     VALUE(I_PERNR) TYPE  PERSNO OPTIONAL
*"     VALUE(I_NACHN) TYPE  NACHN OPTIONAL
*"     VALUE(I_FLAG) TYPE  STRING OPTIONAL
*"  TABLES
*"      OT_BKHZ STRUCTURE  ZSHR_PCZHLY_001 OPTIONAL
*"----------------------------------------------------------------------
*  PA2001缺勤信息  PA2002出勤信息


  DATA:L_DATA   TYPE SY-DATUM,
       L_BEGDA  TYPE SY-DATUM,
       L_BEGDA1 TYPE SY-DATUM,
       L_ENDDA  TYPE SY-DATUM,
       L_ENDDA1 TYPE SY-DATUM.
  DATA:LT_2001   LIKE TABLE OF PA2001 WITH HEADER LINE,
       LT_PA2001 LIKE TABLE OF PA2001 WITH HEADER LINE,
       LT_2002   LIKE TABLE OF PA2001 WITH HEADER LINE.
  DATA:LT_STRUC LIKE TABLE OF STRUC WITH HEADER LINE,
       LT_OBJEC LIKE TABLE OF OBJEC WITH HEADER LINE.
  DATA:NACHN  TYPE STRING,SEX TYPE STRING,AGE TYPE STRING,BUMEN TYPE STRING,
       ZHIWEI TYPE STRING,GL  TYPE STRING,NJ  TYPE STRING,NJSY TYPE STRING.
  DATA: LT_ZPCZHLYXYFS LIKE TABLE OF ZPCZHLYXYFS WITH HEADER LINE.
  DATA:FLAG_GL TYPE STRING,FLAG_NJ TYPE STRING,L_ZXYFS TYPE ZPCZHLYXYFS-ZXYFS.
  DATA:LT_PA0001    LIKE TABLE OF PA0001 WITH HEADER LINE,
       LT_PA0000    LIKE TABLE OF PA0000 WITH HEADER LINE,
       LT_ZPCSSGWBC LIKE TABLE OF ZPCSSGWBC WITH HEADER LINE,
       OT_RLZ       LIKE TABLE OF PA0000 WITH HEADER LINE.

  DATA: SCHKZ   TYPE PA0007-SCHKZ.
  DATA: LT_PA9048 LIKE TABLE OF PA9048 WITH HEADER LINE.
  DATA:BEGIN OF LT_RESULT_SEARCH OCCURS 0,
         PERNR  LIKE ZHR_PT_KQ01-PERNR,
         AWART  LIKE ZHR_PT_KQ01-AWART,
         BEGDA  LIKE ZHR_PT_KQ01-BEGDA,
         ENDDA  LIKE ZHR_PT_KQ01-ENDDA,
         NACHN  LIKE ZHR_PT_KQ01-NACHN,
         AGE    LIKE ZHR_PT_KQ01-AGE,
         SEX    LIKE ZHR_PT_KQ01-SEX,
         BUMEN  LIKE ZHR_PT_KQ01-BUMEN,
         ZHIWEI LIKE ZHR_PT_KQ01-ZHIWEI,
         DATA   LIKE ZHR_PT_KQ01-DATA,
         SPRPS  LIKE ZHR_PT_KQ01-SPRPS,
         FLAG1  LIKE ZHR_PT_KQ01-FLAG1,
         FLAG2  LIKE ZHR_PT_KQ01-FLAG2,
         FLAG3  LIKE ZHR_PT_KQ01-FLAG3,
         FLAG4  LIKE ZHR_PT_KQ01-FLAG4,
         FLAG5  LIKE ZHR_PT_KQ01-FLAG5,
       END OF LT_RESULT_SEARCH.
  DATA:LT_RESULT_SEARCH1 LIKE TABLE OF LT_RESULT_SEARCH WITH HEADER LINE.
  DATA:LT_ZTHR_PCSS_JB LIKE TABLE OF ZTHR_PCSS_JB WITH HEADER LINE.

  DATA:RESULT_SEARCH LIKE TABLE OF ZSHR_PCJG_002 WITH HEADER LINE,
       RESULT_JB     LIKE TABLE OF ZSHR_PCJG_006 WITH HEADER LINE.

  IF I_FLAG = 0 .
    CALL FUNCTION 'ZHR_PC_PUBLIC_002' " 获取考勤周期
      EXPORTING
        I_DATE  = I_ENDDA
      IMPORTING
        O_BEGDA = L_BEGDA1 "本月的考勤周期
        O_ENDDA = L_ENDDA1.

    IF I_ENDDA > L_ENDDA1.   "输入时间为上月考勤时间段,限定输入时间只能为考勤周期之内
      CALL FUNCTION 'FIMA_DATE_CREATE'
        EXPORTING
          I_DATE   = L_ENDDA1
          I_MONTHS = '1'
        IMPORTING
          E_DATE   = L_ENDDA1.
      CONCATENATE L_ENDDA1+0(6) '01' INTO L_ENDDA1.
      CALL FUNCTION 'ZHR_PC_PUBLIC_002'
        EXPORTING
          I_DATE  = L_ENDDA1
        IMPORTING
          O_BEGDA = L_BEGDA1
          O_ENDDA = L_ENDDA1.
    ENDIF.
    L_BEGDA = I_BEGDA. L_ENDDA = I_ENDDA.

    IF I_ENDDA > L_ENDDA1.
      L_ENDDA = L_ENDDA1.
    ENDIF.
    IF I_BEGDA < L_BEGDA1.
      L_BEGDA = L_BEGDA1.
    ENDIF.

  ELSEIF I_FLAG = 1 OR I_FLAG = 2 .
    CALL FUNCTION 'ZHR_PC_PUBLIC_002' " 获取考勤周期
      EXPORTING
        I_DATE  = I_ENDDA
      IMPORTING
        O_BEGDA = L_BEGDA1
        O_ENDDA = L_ENDDA1.
    IF I_ENDDA > L_ENDDA1.   "输入时间为上月考勤时间段,限定输入时间只能为考勤周期之内
      CALL FUNCTION 'FIMA_DATE_CREATE'
        EXPORTING
          I_DATE   = L_ENDDA1
          I_MONTHS = '1'
        IMPORTING
          E_DATE   = L_ENDDA1.
      CONCATENATE L_ENDDA1+0(6) '01' INTO L_ENDDA1.
      CALL FUNCTION 'ZHR_PC_PUBLIC_002'
        EXPORTING
          I_DATE  = L_ENDDA1
        IMPORTING
          O_BEGDA = L_BEGDA1
          O_ENDDA = L_ENDDA1.
    ENDIF.
    L_BEGDA = I_BEGDA. L_ENDDA = I_ENDDA.

    IF I_ENDDA > L_ENDDA1.
      L_ENDDA = L_ENDDA1.
    ENDIF.
    IF I_BEGDA < L_BEGDA1.
      L_BEGDA = L_BEGDA1.
    ENDIF.
  ELSEIF I_FLAG = 3.
    L_BEGDA = I_ENDDA. L_ENDDA = I_ENDDA.
    FLAG_GL = 'X'.FLAG_NJ = 'X'.
  ENDIF.

  DATA:GT_BEGDA LIKE SY-DATUM,GT_ENDDA LIKE SY-DATUM.
  "上个月的考勤期间
*  CALL FUNCTION 'ZHR_PC_PUBLIC_002'
*      EXPORTING
*        I_DATE  = L_BEGDA
*      IMPORTING
*        O_BEGDA = GT_BEGDA
*        O_ENDDA = GT_ENDDA.
*  CONCATENATE GT_BEGDA+0(6) '26' INTO GT_BEGDA.
*  CONCATENATE L_BEGDA+0(6) '25' INTO GT_ENDDA.


  CALL FUNCTION 'RH_STRUC_GET'
    EXPORTING
      ACT_OTYPE      = 'O'
      ACT_OBJID      = I_OBJID
      ACT_WEGID      = 'PERS-O'
*     ACT_INT_FLAG   =
      ACT_PLVAR      = '01'
      ACT_BEGDA      = L_BEGDA
      ACT_ENDDA      = L_ENDDA
    TABLES
*     RESULT_TAB     =
      RESULT_OBJEC   = LT_OBJEC
      RESULT_STRUC   = LT_STRUC
    EXCEPTIONS
      NO_PLVAR_FOUND = 1
      NO_ENTRY_FOUND = 2
      OTHERS         = 3.
  IF SY-SUBRC <> 0.
* Implement suitable error handling here
  ENDIF.

  DELETE LT_STRUC WHERE OTYPE <> 'P'.


  LOOP AT LT_STRUC.
    RESULT_SEARCH-PERNR = LT_STRUC-OBJID.
    CALL FUNCTION 'ZHR_PC_PUBLIC_004'
      EXPORTING
        I_PERNR  = RESULT_SEARCH-PERNR
        I_DATE   = I_ENDDA
*       IN_FLAG_ICNUM       =
*       IN_FLAG_RZRQ        =
      IMPORTING
        O_NACHN  = NACHN
*       O_VORNA  =
        O_SEX    = SEX
        O_AGE    = AGE
        O_BUMEN  = BUMEN
*       O_GZ     =
        O_ZHIWEI = ZHIWEI
*       O_YCQTS  =
*       O_RZRQ   =
*       O_CJGZSJ =
*       O_ICNUM  =
        O_GL     = GL
        O_NJ     = NJ
        O_NJSY   = NJSY
*       O_QHBZ   =
*       O_MONS   =
*       O_YEARS  =
*       O_GLGZ   =
*       O_PLANS  =
*       O_LZRQ   =
*       O_CJBZ   =
      .

    CONDENSE:NACHN,SEX,AGE,BUMEN,ZHIWEI,GL.
    RESULT_SEARCH-NACHN = NACHN.
    RESULT_SEARCH-SEX = SEX.
    RESULT_SEARCH-AGE = AGE.
    RESULT_SEARCH-BUMEN = BUMEN .
    RESULT_SEARCH-ZHIWEI = ZHIWEI.

    RESULT_SEARCH-FLAG1 = GL.
    RESULT_SEARCH-FLAG2 = NJ.
    RESULT_SEARCH-FLAG3 = NJSY.
    RESULT_SEARCH-BEGDA = LT_STRUC-VBEGDA..
    RESULT_SEARCH-ENDDA = LT_STRUC-VENDDA.
    APPEND RESULT_SEARCH.CLEAR RESULT_SEARCH.
  ENDLOOP.

***************************************人员在核算期间内入职、离职、调动查询
***01入职03调动04离职13实习15实习结束
  LOOP AT RESULT_SEARCH.
    IF RESULT_SEARCH-BEGDA BETWEEN L_BEGDA AND L_ENDDA AND RESULT_SEARCH-ENDDA >= L_ENDDA.
      OT_RLZ-PERNR = RESULT_SEARCH-PERNR.
      OT_RLZ-BEGDA = RESULT_SEARCH-BEGDA.
      OT_RLZ-ENDDA = L_ENDDA.
    ELSEIF RESULT_SEARCH-BEGDA BETWEEN L_BEGDA AND L_ENDDA
      AND RESULT_SEARCH-ENDDA BETWEEN L_BEGDA AND L_ENDDA .
      OT_RLZ-PERNR = RESULT_SEARCH-PERNR.
      OT_RLZ-BEGDA = RESULT_SEARCH-BEGDA.
      OT_RLZ-ENDDA = RESULT_SEARCH-ENDDA.
    ELSEIF RESULT_SEARCH-ENDDA BETWEEN L_BEGDA AND L_ENDDA AND  RESULT_SEARCH-BEGDA <= L_BEGDA.
      OT_RLZ-PERNR = RESULT_SEARCH-PERNR.
      OT_RLZ-BEGDA = L_BEGDA.
      OT_RLZ-ENDDA = RESULT_SEARCH-ENDDA.
    ENDIF.
*    IF OT_RLZ-PERNR IS NOT INITIAL.
*      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
*        EXPORTING
*          INPUT  = OT_RLZ-PERNR
*        IMPORTING
*          OUTPUT = OT_RLZ-PERNR.
    APPEND OT_RLZ.CLEAR OT_RLZ.
*    ENDIF.
  ENDLOOP.




  SELECT PERNR BEGDA ENDDA STAT2 INTO CORRESPONDING FIELDS OF TABLE LT_PA0000
      FROM PA0000
      FOR ALL ENTRIES IN RESULT_SEARCH[] WHERE PERNR = RESULT_SEARCH-PERNR
        AND BEGDA <= L_BEGDA AND ENDDA >= L_ENDDA AND STAT2 NE '3'.
  SELECT PERNR BEGDA ENDDA PERSG INTO CORRESPONDING FIELDS OF TABLE LT_PA0001
    FROM PA0001
    FOR ALL ENTRIES IN RESULT_SEARCH[] WHERE PERNR = RESULT_SEARCH-PERNR
      AND BEGDA <= L_BEGDA AND ENDDA >= L_ENDDA AND PERSG = 'M'.

  LOOP AT RESULT_SEARCH.
    READ TABLE LT_PA0001 WITH KEY PERNR = RESULT_SEARCH-PERNR.
    IF SY-SUBRC = 0.
      DELETE RESULT_SEARCH.
    ENDIF.
    READ TABLE LT_PA0000 WITH KEY PERNR = RESULT_SEARCH-PERNR.
    IF SY-SUBRC = 0.
      DELETE RESULT_SEARCH.
    ENDIF.
  ENDLOOP.

  SORT RESULT_SEARCH BY PERNR.

  IF I_PERNR IS NOT INITIAL.
    DELETE RESULT_SEARCH WHERE PERNR <> I_PERNR.
  ENDIF.
  IF I_NACHN IS NOT INITIAL.
    DELETE RESULT_SEARCH WHERE NACHN <> I_NACHN.
  ENDIF.
*******************取职位信息手工维护的
  SELECT * INTO CORRESPONDING FIELDS OF TABLE LT_PA9048 FROM PA9048 FOR ALL ENTRIES IN RESULT_SEARCH WHERE PERNR = RESULT_SEARCH-PERNR
    AND BEGDA <= L_BEGDA AND ENDDA >= L_ENDDA.


  LOOP AT RESULT_SEARCH.

*    SELECT SINGLE ZXYFS INTO RESULT_SEARCH-FLAG5 FROM ZPCZHLYXYFS WHERE PERNR = RESULT_SEARCH-PERNR
*        AND BEGDA = LT_BEGDA.

*    SELECT SINGLE SCHKZ INTO SCHKZ FROM PA0007 WHERE PERNR = RESULT_SEARCH-PERNR AND BEGDA <= L_ENDDA AND ENDDA >= L_BEGDA.
    SELECT * INTO CORRESPONDING FIELDS OF TABLE LT_ZPCSSGWBC FROM ZPCSSGWBC
              WHERE PERNR = RESULT_SEARCH-PERNR AND BEGDA = L_BEGDA.
    IF LT_ZPCSSGWBC[] IS NOT INITIAL .
*      READ TABLE LT_PA9048 with KEY pernr = RESULT_SEARCH-pernr.
*      if sy-subrc = 0.
      CLEAR RESULT_SEARCH-ZHIWEI.
      LOOP AT LT_ZPCSSGWBC.
        IF RESULT_SEARCH-ZHIWEI IS  INITIAL.
          RESULT_SEARCH-ZHIWEI  = LT_ZPCSSGWBC-ZJB_TXT.
        ELSE.
          CONCATENATE RESULT_SEARCH-ZHIWEI  ',' LT_ZPCSSGWBC-ZJB_TXT INTO RESULT_SEARCH-ZHIWEI.
        ENDIF.
      ENDLOOP.

    ENDIF.

***********************
    MODIFY RESULT_SEARCH.
  ENDLOOP.



  REFRESH:LT_2001[],LT_2002[].
  SELECT PERNR SUBTY SPRPS BEGDA ENDDA AWART INTO CORRESPONDING FIELDS OF TABLE LT_2001
        FROM PA2001
        FOR ALL ENTRIES IN RESULT_SEARCH[] WHERE PERNR = RESULT_SEARCH-PERNR "AND FLAG1 = 2 "2审批完成
        AND BEGDA BETWEEN L_BEGDA AND L_ENDDA AND ENDDA BETWEEN L_BEGDA AND L_ENDDA.
  SORT LT_2001 BY PERNR.

  SELECT PERNR SUBTY SPRPS BEGDA ENDDA AWART INTO CORRESPONDING FIELDS OF TABLE LT_2002
    FROM PA2002
    FOR ALL ENTRIES IN RESULT_SEARCH[] WHERE PERNR = RESULT_SEARCH-PERNR "AND FLAG1 = 2
    AND BEGDA BETWEEN L_BEGDA AND L_ENDDA AND ENDDA BETWEEN L_BEGDA AND L_ENDDA.
  SORT LT_2002 BY PERNR.





  IF I_FLAG = 1 OR I_FLAG = 2.
    DATA:TIMES TYPE P DECIMALS 2.
    LOOP AT RESULT_SEARCH.
      LOOP AT LT_2002 WHERE PERNR = RESULT_SEARCH-PERNR.
        IF LT_2002-AWART+0(3) = '101'.   "出勤
          CLEAR:TIMES.
          IF LT_2002-AWART = '1010'.
            TIMES = TIMES + 1.
          ELSE.
            TIMES = TIMES + ( 1 / 2 ).
          ENDIF.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '1010'.
          LT_RESULT_SEARCH-FLAG1 = '出勤'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
*        ELSEIF LT_2002-AWART+0(3) = '102'.   "晚班
*          CLEAR:TIMES.
*          IF LT_2002-AWART = '1020'.
*            TIMES = TIMES + 1.
*          ELSE.
*            TIMES = TIMES + ( 1 / 2 ).
*          ENDIF.
*          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
*          LT_RESULT_SEARCH-AWART = '1020'.
*          LT_RESULT_SEARCH-FLAG1 = '晚班'.
*          LT_RESULT_SEARCH-FLAG2 = TIMES.
*          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2002-AWART = '1030'.   "外派
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '1030'.
          LT_RESULT_SEARCH-FLAG1 = '外派天数'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
*        ELSEIF LT_2002-AWART+0(3) = '104'.   "夜班天数
*          CLEAR:TIMES.
*          IF LT_2002-AWART = '1040'.
*            TIMES = TIMES + 1.
*          ELSE.
*            TIMES = TIMES + ( 1 / 2 ).
*          ENDIF.
*          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
*          LT_RESULT_SEARCH-AWART = '1040'.
*          LT_RESULT_SEARCH-FLAG1 = '夜班天数'.
*          LT_RESULT_SEARCH-FLAG2 = TIMES.
*          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
****          2017.4.24根据魏芳需求修改由1050改为1210,1060改为1220。修改人李瀚
        ELSEIF LT_2002-AWART = '1210'.   "出差
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '1210'.
          LT_RESULT_SEARCH-FLAG1 = '出差天数'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2002-AWART+0(3) = '122'.   "外出
          CLEAR:TIMES.
          IF LT_2002-AWART = '1220'.
            TIMES = TIMES + 1.
          ELSE.
            TIMES = TIMES + ( 1 / 2 ).
          ENDIF.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '1220'.
          LT_RESULT_SEARCH-FLAG1 = '外出天数'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2002-AWART = '1230'.   "值班即加班
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '1230'.
          LT_RESULT_SEARCH-FLAG1 = '加班'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.

        ELSEIF LT_2002-AWART = '1240'.   "高温出勤
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '1240'.
          LT_RESULT_SEARCH-FLAG1 = '高温出勤'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2002-AWART = '1241'.   "低温出勤
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '1241'.
          LT_RESULT_SEARCH-FLAG1 = '低温出勤'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ENDIF.
      ENDLOOP.

      LOOP AT LT_2001 WHERE PERNR = RESULT_SEARCH-PERNR.
*        IF LT_2001-AWART = '2000'.  "年假
        IF LT_2001-AWART+0(3) = '200'.  "年假
          CLEAR:TIMES.
          IF LT_2001-AWART = '2000'.
            TIMES = TIMES + 1.
          ELSE.
            TIMES = TIMES + ( 1 / 2 ).
          ENDIF.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2000'.
          LT_RESULT_SEARCH-FLAG1 = '年假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART+0(3) = '201'.   "事假
          CLEAR:TIMES.
          IF LT_2001-AWART = '2010'.
            TIMES = TIMES + 1.
          ELSE.
            TIMES = TIMES + ( 1 / 2 ).
          ENDIF.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2010'.
          LT_RESULT_SEARCH-FLAG1 = '事假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART+0(3) = '202'.   "病假
          CLEAR:TIMES.
          IF LT_2001-AWART = '2020'.
            TIMES = TIMES + 1.
          ELSE.
            TIMES = TIMES + ( 1 / 2 ).
          ENDIF.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2020'.
          LT_RESULT_SEARCH-FLAG1 = '病假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART+0(3) = '999'.   "调休
          CLEAR:TIMES.
          IF LT_2001-AWART = '9998'.
            TIMES = TIMES + 1.
          ELSEIF LT_2001-AWART = '9997'.
            TIMES = TIMES + ( 1 / 2 ).
          ELSEIF LT_2001-AWART = '9996'.
            TIMES = TIMES + ( 1 / 2 ).
          ENDIF.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '9998'.
          LT_RESULT_SEARCH-FLAG1 = '调休'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART+0(3) = '999'.   "休息
          CLEAR:TIMES.
          IF LT_2001-AWART = '9999'.
            TIMES = TIMES + 1.
          ELSEIF LT_2001-AWART = '9994'.
            TIMES = TIMES + ( 1 / 2 ).
          ELSEIF LT_2001-AWART = '9995'.
            TIMES = TIMES + ( 1 / 2 ).
          ENDIF.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '9999'.
          LT_RESULT_SEARCH-FLAG1 = '休'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.


        ELSEIF LT_2001-AWART = '2030'.  "婚假
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2030'.
          LT_RESULT_SEARCH-FLAG1 = '婚假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '2040'.  "丧假
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2040'.
          LT_RESULT_SEARCH-FLAG1 = '丧假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
*        ELSEIF LT_2001-AWART = '2050'.  "产前假
*          CLEAR:TIMES.
*          TIMES = TIMES + 1.
*          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
*          LT_RESULT_SEARCH-AWART = '2050'.
*          LT_RESULT_SEARCH-FLAG1 = '产前假'.
*          LT_RESULT_SEARCH-FLAG2 = TIMES.
*          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '2051'.  "产后假
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2051'.
          LT_RESULT_SEARCH-FLAG1 = '产后假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '3000'.  "节育假
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '3000'.
          LT_RESULT_SEARCH-FLAG1 = '节育假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '2060'.  "工伤假
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2060'.
          LT_RESULT_SEARCH-FLAG1 = '工伤假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '2070'.  "流产假
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2070'.
          LT_RESULT_SEARCH-FLAG1 = '流产假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '2080'.  "停工假
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2080'.
          LT_RESULT_SEARCH-FLAG1 = '停工假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '2090'.  "旅游假
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2090'.
          LT_RESULT_SEARCH-FLAG1 = '旅游假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '3010'.  "迟到
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '3010'.
          LT_RESULT_SEARCH-FLAG1 = '迟到'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '3020'.  "早退
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '3020'.
          LT_RESULT_SEARCH-FLAG1 = '早退'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '3030'.  "旷工
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '3030'.
          LT_RESULT_SEARCH-FLAG1 = '旷工'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ENDIF.
      ENDLOOP.

    ENDLOOP.
  ENDIF.



  IF I_FLAG = 0.     "考勤明细表

    LOOP AT LT_2001.
      READ TABLE RESULT_SEARCH WITH KEY PERNR = LT_2001-PERNR BINARY SEARCH.
      IF SY-SUBRC = 0.
        MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
        LT_RESULT_SEARCH-DATA  = LT_2001-BEGDA.
        LT_RESULT_SEARCH-AWART = LT_2001-AWART.
        LT_RESULT_SEARCH-SPRPS = LT_2001-SPRPS.
        APPEND LT_RESULT_SEARCH.CLEAR LT_RESULT_SEARCH.
      ENDIF.
    ENDLOOP.
    LOOP AT LT_2002.
      READ TABLE RESULT_SEARCH WITH KEY PERNR = LT_2002-PERNR BINARY SEARCH.
      IF SY-SUBRC = 0.
        MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
        LT_RESULT_SEARCH-DATA  = LT_2002-BEGDA.
        LT_RESULT_SEARCH-AWART = LT_2002-AWART.
        LT_RESULT_SEARCH-SPRPS = LT_2002-SPRPS.
        APPEND LT_RESULT_SEARCH.CLEAR LT_RESULT_SEARCH.
      ENDIF.
    ENDLOOP.

    LOOP AT RESULT_SEARCH.
      LOOP AT LT_2002 WHERE PERNR = RESULT_SEARCH-PERNR.
        IF LT_2002-AWART+0(3) = '101'.   "出勤
          CLEAR:TIMES.
          IF LT_2002-AWART = '1010'.
            TIMES = TIMES + 1.
          ELSE.
            TIMES = TIMES + ( 1 / 2 ).
          ENDIF.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '1010'.
          LT_RESULT_SEARCH-FLAG1 = '出勤'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2002-AWART+0(3) = '102'.   "晚班
          CLEAR:TIMES.
          IF LT_2002-AWART = '1020'.
            TIMES = TIMES + 1.
          ELSE.
            TIMES = TIMES + ( 1 / 2 ).
          ENDIF.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '1020'.
          LT_RESULT_SEARCH-FLAG1 = '晚班'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2002-AWART = '1030'.   "外派
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '1030'.
          LT_RESULT_SEARCH-FLAG1 = '外派天数'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
*****     根据魏芳需求修改由1050改为1210,1060改为1220。修改人李瀚
        ELSEIF LT_2002-AWART = '1210'.   "出差
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '1210'.
          LT_RESULT_SEARCH-FLAG1 = '出差天数'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2002-AWART = '1230'.   "值班即加班
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '1230'.
          LT_RESULT_SEARCH-FLAG1 = '加班'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2002-AWART = '1240'.   "高温出勤
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '1240'.
          LT_RESULT_SEARCH-FLAG1 = '高温出勤'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2002-AWART = '1241'.   "低温出勤
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '1241'.
          LT_RESULT_SEARCH-FLAG1 = '低温出勤'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2002-AWART+0(3) = '104'.   "夜班天数
          CLEAR:TIMES.
          IF LT_2002-AWART = '1040'.
            TIMES = TIMES + 1.
          ELSE.
            TIMES = TIMES + ( 1 / 2 ).
          ENDIF.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '1040'.
          LT_RESULT_SEARCH-FLAG1 = '夜班天数'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2002-AWART+0(3) = '106'.   "外出
          CLEAR:TIMES.
          IF LT_2002-AWART = '1060'.
            TIMES = TIMES + 1.
          ELSE.
            TIMES = TIMES + ( 1 / 2 ).
          ENDIF.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '1060'.
          LT_RESULT_SEARCH-FLAG1 = '外出天数'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ENDIF.
      ENDLOOP.

      LOOP AT LT_2001 WHERE PERNR = RESULT_SEARCH-PERNR.
*        IF LT_2001-AWART = '2000'.  "年假
        IF LT_2001-AWART+0(3) = '200'.  "年假
          CLEAR:TIMES.
          IF LT_2001-AWART = '2000'.
            TIMES = TIMES + 1.
          ELSE.
            TIMES = TIMES + ( 1 / 2 ).
          ENDIF.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2000'.
          LT_RESULT_SEARCH-FLAG1 = '年假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART+0(3) = '201'.   "事假
          CLEAR:TIMES.
          IF LT_2001-AWART = '2010'.
            TIMES = TIMES + 1.
          ELSE.
            TIMES = TIMES + ( 1 / 2 ).
          ENDIF.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2010'.
          LT_RESULT_SEARCH-FLAG1 = '事假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
***          根据魏芳需求修改由1050改为1210,1060改为1220。修改人李瀚
        ELSEIF LT_2001-AWART+0(3) = '122'.   "外出
          CLEAR:TIMES.
          IF LT_2001-AWART = '1220'.
            TIMES = TIMES + 1.
          ELSE.
            TIMES = TIMES + ( 1 / 2 ).
          ENDIF.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '1220'.
          LT_RESULT_SEARCH-FLAG1 = '外出'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART+0(3) = '202'.   "病假
          CLEAR:TIMES.
          IF LT_2001-AWART = '2020'.
            TIMES = TIMES + 1.
          ELSE.
            TIMES = TIMES + ( 1 / 2 ).
          ENDIF.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2020'.
          LT_RESULT_SEARCH-FLAG1 = '病假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '2030'.  "婚假
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2030'.
          LT_RESULT_SEARCH-FLAG1 = '婚假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '2040'.  "丧假
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2040'.
          LT_RESULT_SEARCH-FLAG1 = '丧假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '2050'.  "产前假
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2050'.
          LT_RESULT_SEARCH-FLAG1 = '产前假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '2051'.  "产后假
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2051'.
          LT_RESULT_SEARCH-FLAG1 = '产后假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '3000'.  "节育假
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '3000'.
          LT_RESULT_SEARCH-FLAG1 = '节育假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '2060'.  "工伤假
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2060'.
          LT_RESULT_SEARCH-FLAG1 = '工伤假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '2070'.  "流产假
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2070'.
          LT_RESULT_SEARCH-FLAG1 = '流产假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '2080'.  "停工假
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2080'.
          LT_RESULT_SEARCH-FLAG1 = '停工假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '2090'.  "旅游假
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '2090'.
          LT_RESULT_SEARCH-FLAG1 = '旅游假'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '3010'.  "迟到
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '3010'.
          LT_RESULT_SEARCH-FLAG1 = '迟到'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '3020'.  "早退
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '3020'.
          LT_RESULT_SEARCH-FLAG1 = '早退'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ELSEIF LT_2001-AWART = '3030'.  "旷工
          CLEAR:TIMES.
          TIMES = TIMES + 1.
          MOVE-CORRESPONDING RESULT_SEARCH TO LT_RESULT_SEARCH.
          LT_RESULT_SEARCH-AWART = '3030'.
          LT_RESULT_SEARCH-FLAG1 = '旷工'.
          LT_RESULT_SEARCH-FLAG2 = TIMES.
          APPEND LT_RESULT_SEARCH. CLEAR LT_RESULT_SEARCH.
        ENDIF.
      ENDLOOP.
      CLEAR RESULT_SEARCH.
    ENDLOOP.
*    CLEAR:RESULT_SEARCH,RESULT_SEARCH[].

    LOOP AT RESULT_SEARCH.
      READ TABLE LT_RESULT_SEARCH WITH KEY PERNR = RESULT_SEARCH-PERNR.
      IF SY-SUBRC = 0.
        DELETE RESULT_SEARCH.
      ENDIF.
    ENDLOOP.
    LOOP AT LT_RESULT_SEARCH.
      MOVE-CORRESPONDING LT_RESULT_SEARCH TO RESULT_SEARCH.
      APPEND RESULT_SEARCH. CLEAR RESULT_SEARCH.
    ENDLOOP.

*********************加班
    DATA:LT_PA2005 LIKE TABLE OF PA2005 WITH HEADER LINE.
    SELECT PERNR BEGDA ENDDA STDAZ VERSL FLAG1 FLAG2 BWGRL INTO CORRESPONDING FIELDS OF TABLE LT_PA2005
      FROM PA2005
      FOR ALL ENTRIES IN RESULT_SEARCH[] WHERE PERNR = RESULT_SEARCH-PERNR
      AND BEGDA BETWEEN L_BEGDA AND L_ENDDA AND ENDDA BETWEEN L_BEGDA AND L_ENDDA.
    LOOP AT LT_PA2005.
      RESULT_JB-PERNR = LT_PA2005-PERNR.   "员工编号
      RESULT_JB-BEGDA = LT_PA2005-BEGDA.   "加班日期
      RESULT_JB-STDAZ = LT_PA2005-STDAZ.
      RESULT_JB-VERSL = LT_PA2005-VERSL.
*      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
*        EXPORTING
*          INPUT  = RESULT_JB-PERNR
*        IMPORTING
*          OUTPUT = RESULT_JB-PERNR.
      APPEND RESULT_JB. CLEAR RESULT_JB.
    ENDLOOP.

    LOOP AT RESULT_SEARCH.
      OT_BKHZ-SMON = I_ENDDA+0(6).
      OT_BKHZ-OBJID = I_OBJID.
      OT_BKHZ-STEXT = RESULT_SEARCH-STEXT.
      OT_BKHZ-PERNR = RESULT_SEARCH-PERNR.
      OT_BKHZ-NACHN = RESULT_SEARCH-NACHN.
      OT_BKHZ-ZHIWEI = RESULT_SEARCH-ZHIWEI.
*      OT_BKHZ-ZXYFS = RESULT_SEARCH-FLAG5.
      IF RESULT_SEARCH-AWART = '3010'.
        OT_BKHZ-CD = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART = '3030'.
        OT_BKHZ-KG = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART = '2060'.
        OT_BKHZ-GSJ = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART+0(3) = '200'.
        OT_BKHZ-NJ = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART+0(3) = '201'.
        OT_BKHZ-SJ = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART+0(3) = '202'.
        OT_BKHZ-BJ = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART = '2030'.
        OT_BKHZ-HJ = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART = '2050'.
        OT_BKHZ-CJ = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART = '2051'.
        OT_BKHZ-CJ = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART = '2040'.
        OT_BKHZ-SHJ = RESULT_SEARCH-FLAG2.
      ENDIF.
****      根据魏芳需求修改由1050改为1210,1060改为1220。修改人李瀚
      IF RESULT_SEARCH-AWART = '1210'. "出差
        OT_BKHZ-CC = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART = '1220'.
        OT_BKHZ-WC = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART = '1230'.
        OT_BKHZ-JAB = RESULT_SEARCH-FLAG2.
      ENDIF.
      COLLECT OT_BKHZ.
      CLEAR:OT_BKHZ,RESULT_SEARCH.
    ENDLOOP.

*    LOOP AT OT_BKHZ.
*      LOOP AT RESULT_JB WHERE PERNR = OT_BKHZ-PERNR ."AND ( VERSL = 'A' OR VERSL = 'B' ).
**        OT_BKHZ-JAB = OT_BKHZ-JAB + RESULT_JB-STDAZ.
*        IF RESULT_JB-STDAZ = '8'.
*          OT_BKHZ-JAB = OT_BKHZ-JAB + 1.
*        ELSEIF RESULT_JB-STDAZ = '4'.
*          OT_BKHZ-JAB = OT_BKHZ-JAB + ( 1 / 2 ).
*        ENDIF.
*        CLEAR:RESULT_JB.
*      ENDLOOP.
*      MODIFY OT_BKHZ.
*      CLEAR OT_BKHZ.
*    ENDLOOP.


    DATA:LT_PERWS LIKE TABLE OF PTPSP WITH HEADER LINE.
    DATA:LT_PERWS1 LIKE TABLE OF PTPSP WITH HEADER LINE.
    DATA:L_WOTNR TYPE P,NUM TYPE I,S_ANZHL LIKE PA2006-ANZHL.
    DATA:TIAOXIU TYPE P DECIMALS 2.
    DATA:XIU TYPE P DECIMALS 2.
    DATA:JIABAN TYPE P DECIMALS 2.
    LOOP AT OT_BKHZ.    "DAY_IN_WEEK
      CLEAR:LT_PERWS,LT_PERWS[],SCHKZ,NUM,JIABAN.
      LOOP AT RESULT_JB WHERE PERNR = OT_BKHZ-PERNR AND ( VERSL = 'A' OR VERSL = 'B' ).
        IF RESULT_JB-STDAZ = '8'.
          JIABAN = JIABAN + 1.
        ELSEIF RESULT_JB-STDAZ = '4'.
          JIABAN = JIABAN + ( 1 / 2 ).
        ENDIF.
      ENDLOOP.

      READ TABLE OT_RLZ WITH KEY PERNR = OT_BKHZ-PERNR."考勤期间入离职
      IF SY-SUBRC = 0.
        L_BEGDA1 = OT_RLZ-BEGDA.
        L_ENDDA1 = OT_RLZ-ENDDA.
      ELSE.
        L_BEGDA1 = L_BEGDA.
        L_ENDDA1 = L_ENDDA.
      ENDIF.


      CALL FUNCTION 'HR_PERSONAL_WORK_SCHEDULE'
        EXPORTING
          PERNR         = OT_BKHZ-PERNR
          BEGDA         = L_BEGDA1
          ENDDA         = L_ENDDA1
        TABLES
          PERWS         = LT_PERWS
        EXCEPTIONS
          ERROR_OCCURED = 1
          ABORT_OCCURED = 2
          OTHERS        = 3.
      CLEAR SCHKZ.
      SELECT SINGLE SCHKZ INTO SCHKZ FROM PA0007 WHERE PERNR = OT_BKHZ-PERNR AND BEGDA <= L_ENDDA AND ENDDA >= L_BEGDA.

      "应出勤

      IF SCHKZ = 'P3'.
        LOOP AT LT_PERWS .
          IF LT_PERWS-ACTIV = 'X' AND LT_PERWS-TPROG = 'WORK' AND LT_PERWS-TAGTY <> '1' ."工作日
            OT_BKHZ-YCQTS = OT_BKHZ-YCQTS + 1.
          ELSEIF LT_PERWS-ACTIV = 'X' AND LT_PERWS-TAGTY = '1' . "法定假期
            OT_BKHZ-YCQTS = OT_BKHZ-YCQTS + 1.
          ENDIF.
        ENDLOOP.
      ELSEIF SCHKZ = 'P1'.
        LOOP AT LT_PERWS WHERE ACTIV = 'X' AND TPROG = 'WORK' AND TAGTY <> '1' AND TAGTY <> '2'."AND FTKLA <> '1'.
          OT_BKHZ-YCQTS = OT_BKHZ-YCQTS + 1.
        ENDLOOP.
        LOOP AT LT_PERWS WHERE ACTIV = 'X'  AND FTKLA = '1'.
          OT_BKHZ-YCQTS = OT_BKHZ-YCQTS + 1.
        ENDLOOP.
        LOOP AT LT_PERWS WHERE ACTIV = 'X'  AND TPROG = 'HALF' .
          OT_BKHZ-YCQTS = OT_BKHZ-YCQTS + (  1 / 2 ).
        ENDLOOP.
      ENDIF.
      "月应休

      IF SCHKZ = 'P3'.
        OT_BKHZ-YYX = L_ENDDA1 - L_BEGDA1 + 1 - OT_BKHZ-YCQTS.
      ELSEIF SCHKZ = 'P1'.
        OT_BKHZ-YYX = L_ENDDA1 - L_BEGDA1 + 1 - OT_BKHZ-YCQTS.
      ENDIF.

**       2001存调休
      CLEAR :TIAOXIU.
      LOOP AT LT_2001 WHERE PERNR = OT_BKHZ-PERNR AND ( AWART = '9996' OR AWART = '9997'OR AWART = '9998' ).
        IF LT_2001-AWART = '9996' OR LT_2001-AWART = '9997'.
          TIAOXIU = TIAOXIU + ( 1 / 2 ).
        ELSEIF LT_2001-AWART = '9998'.
          TIAOXIU = TIAOXIU + 1.
        ENDIF.
      ENDLOOP.

***************      2017.5.18修改产假逻辑-李瀚    "实出勤
      DATA:NUM1 TYPE I,NUM2 TYPE I.

      IF SCHKZ = 'P2'.
        IF OT_BKHZ-CJ IS NOT INITIAL.
          CLEAR :XIU.
          LOOP AT LT_2001 WHERE PERNR = OT_BKHZ-PERNR AND ( AWART = '9999' OR AWART = '9994'OR AWART = '9995' ).
            READ TABLE LT_PERWS WITH KEY ACTIV = 'X' TAGTY = '1' DATUM = LT_2001-BEGDA.
            IF SY-SUBRC = 0.
              IF LT_2001-AWART = '9999'.
                OT_BKHZ-FDJJR = OT_BKHZ-FDJJR + 1 .
              ELSEIF LT_2001-AWART = '9994'.
                OT_BKHZ-FDJJR = OT_BKHZ-FDJJR + ( 1 / 2 ).
              ELSEIF LT_2001-AWART = '9995'.
                OT_BKHZ-FDJJR = OT_BKHZ-FDJJR + ( 1 / 2 ).
              ENDIF.
            ENDIF.
            IF LT_2001-AWART = '9999'.
              XIU = XIU + 1 .
            ELSEIF LT_2001-AWART = '9994'.
              XIU = XIU + ( 1 / 2 ).
            ELSEIF LT_2001-AWART = '9995'.
              XIU = XIU + ( 1 / 2 ).
            ENDIF.
          ENDLOOP.
          OT_BKHZ-YSX = XIU + OT_BKHZ-BJ + OT_BKHZ-SJ + OT_BKHZ-KG + TIAOXIU + OT_BKHZ-CJ .
          OT_BKHZ-SCQTS = L_ENDDA1 - L_BEGDA1 + 1 -  OT_BKHZ-YSX.
        ELSE.
          CLEAR :XIU.
          LOOP AT LT_2001 WHERE PERNR = OT_BKHZ-PERNR AND ( AWART = '9999' OR AWART = '9994'OR AWART = '9995' ).
            READ TABLE LT_PERWS WITH KEY ACTIV = 'X' TAGTY = '1' DATUM = LT_2001-BEGDA.
            IF SY-SUBRC = 0.
              IF LT_2001-AWART = '9999'.
                OT_BKHZ-FDJJR = OT_BKHZ-FDJJR + 1 .
              ELSEIF LT_2001-AWART = '9994'.
                OT_BKHZ-FDJJR = OT_BKHZ-FDJJR + ( 1 / 2 ).
              ELSEIF LT_2001-AWART = '9995'.
                OT_BKHZ-FDJJR = OT_BKHZ-FDJJR + ( 1 / 2 ).
              ENDIF.
            ENDIF.
            IF LT_2001-AWART = '9999'.
              XIU = XIU + 1 .
            ELSEIF LT_2001-AWART = '9994'.
              XIU = XIU + ( 1 / 2 ).
            ELSEIF LT_2001-AWART = '9995'.
              XIU = XIU + ( 1 / 2 ).
            ENDIF.
          ENDLOOP.
          OT_BKHZ-YSX = XIU + OT_BKHZ-BJ + OT_BKHZ-SJ + OT_BKHZ-KG + TIAOXIU.
          OT_BKHZ-SCQTS = L_ENDDA1 - L_BEGDA1 + 1 -  OT_BKHZ-YSX.
        ENDIF.


      ELSEIF SCHKZ = 'P3'.
        IF OT_BKHZ-CJ IS NOT INITIAL.
          CLEAR NUM1.
          SELECT * INTO CORRESPONDING FIELDS OF TABLE LT_PA2001 FROM PA2001 WHERE PERNR = OT_BKHZ-PERNR
        AND BEGDA BETWEEN L_BEGDA AND L_ENDDA AND ENDDA BETWEEN L_BEGDA AND L_ENDDA
        AND AWART = '2051'.  "查询这个人的所有产假
          LOOP AT LT_PA2001.
            CALL FUNCTION 'HR_PERSONAL_WORK_SCHEDULE'
              EXPORTING
                PERNR         = LT_PA2001-PERNR
                BEGDA         = LT_PA2001-BEGDA
                ENDDA         = LT_PA2001-ENDDA
              TABLES
                PERWS         = LT_PERWS1
              EXCEPTIONS
                ERROR_OCCURED = 1
                ABORT_OCCURED = 2
                OTHERS        = 3.
            IF SY-SUBRC <> 0.
* Implement suitable error handling here
            ENDIF.
          ENDLOOP.
          LOOP AT LT_PERWS1."法假
            IF LT_PERWS1-ACTIV = 'X' AND  LT_PERWS1-TPROG = 'REST' AND  LT_PERWS1-TAGTY <> '1' .
              NUM1 = NUM1 + 1.
            ENDIF.
          ENDLOOP.

          OT_BKHZ-YSX = OT_BKHZ-CJ +  OT_BKHZ-YYX + OT_BKHZ-BJ + OT_BKHZ-SJ +
           OT_BKHZ-KG + TIAOXIU - JIABAN - NUM1.
        ELSE.
          OT_BKHZ-YSX = OT_BKHZ-YYX + OT_BKHZ-BJ + OT_BKHZ-SJ + OT_BKHZ-KG + TIAOXIU.
          OT_BKHZ-SCQTS = L_ENDDA1 - L_BEGDA1 + 1 -  OT_BKHZ-YSX.
        ENDIF.

      ELSEIF SCHKZ = 'P1'.

        IF OT_BKHZ-CJ IS NOT INITIAL .
          SELECT * INTO CORRESPONDING FIELDS OF TABLE LT_PA2001 FROM PA2001 WHERE PERNR = OT_BKHZ-PERNR
            AND BEGDA BETWEEN L_BEGDA AND L_ENDDA AND ENDDA BETWEEN L_BEGDA AND L_ENDDA
            AND AWART = '2051'.  "查询这个人的所有产假
          LOOP AT LT_PA2001.
            CALL FUNCTION 'HR_PERSONAL_WORK_SCHEDULE'
              EXPORTING
                PERNR         = LT_PA2001-PERNR
                BEGDA         = LT_PA2001-BEGDA
                ENDDA         = LT_PA2001-ENDDA
              TABLES
                PERWS         = LT_PERWS1
              EXCEPTIONS
                ERROR_OCCURED = 1
                ABORT_OCCURED = 2
                OTHERS        = 3.
            IF SY-SUBRC <> 0.
* Implement suitable error handling here
            ENDIF.
          ENDLOOP.
          LOOP AT LT_PERWS1."法假
*            IF LT_PERWS1-ACTIV = 'X' AND LT_PERWS1-FTKLA = '1'.
*              NUM1 = NUM1 + 1.

            IF LT_PERWS1-ACTIV = 'X' AND  LT_PERWS1-TPROG = 'REST' AND  LT_PERWS1-TAGTY <> '1' .
              NUM1 = NUM1 + 1.

            ELSEIF LT_PERWS1-ACTIV = 'X'  AND LT_PERWS1-TPROG = 'HALF' .
              NUM2 = NUM2 + 1.
            ENDIF.
          ENDLOOP.

          OT_BKHZ-SCQTS = L_ENDDA1 - L_BEGDA1 + 1 - OT_BKHZ-YYX - OT_BKHZ-BJ - OT_BKHZ-SJ - OT_BKHZ-KG
          - OT_BKHZ-CJ - TIAOXIU + JIABAN  + NUM1 + NUM2 * ( 1 / 2 )."实出勤
          OT_BKHZ-YSX =  L_ENDDA1 - L_BEGDA1 + 1 - OT_BKHZ-SCQTS."月实休
        ELSE.
          OT_BKHZ-YSX = OT_BKHZ-YYX + OT_BKHZ-BJ + OT_BKHZ-SJ + OT_BKHZ-KG
          + OT_BKHZ-CJ + TIAOXIU - JIABAN. "月实休
          OT_BKHZ-SCQTS = L_ENDDA1 - L_BEGDA1 + 1 - OT_BKHZ-YSX."实出勤
        ENDIF.
      ENDIF.
      CLEAR:NUM1 ,NUM2,LT_PERWS1[].

      IF SCHKZ = 'P2'."应出勤
*        OT_BKHZ-YCQTS = L_ENDDA1 - L_BEGDA1 + 1 - XIU.
*        OT_BKHZ-YYX = L_ENDDA1 - L_BEGDA1 + 1 - OT_BKHZ-YCQTS.
      ENDIF.

***************************************

      "法定节假日
*      LOOP AT LT_PERWS WHERE ACTIV = 'X'  AND FTKLA = '1'.
*        OT_BKHZ-FDJJR = OT_BKHZ-FDJJR + 1.
*      ENDLOOP.
      "年累计存假
      CLEAR S_ANZHL.
      SELECT SINGLE ANZHL INTO S_ANZHL FROM PA2006 WHERE PERNR = OT_BKHZ-PERNR AND KTART = '03'
        AND BEGDA = L_BEGDA AND ENDDA = L_ENDDA.
      IF SCHKZ = 'P2'.
*        OT_BKHZ-NLJCJ = S_ANZHL + OT_BKHZ-YYX -  OT_BKHZ-YSX .
      ELSE.
        OT_BKHZ-NLJCJ = S_ANZHL + OT_BKHZ-JAB - TIAOXIU.
      ENDIF.
      MODIFY OT_BKHZ.CLEAR OT_BKHZ.
    ENDLOOP.
* *************************效益分数ZPCDLCJGWJBPZ
    SELECT * INTO CORRESPONDING FIELDS OF TABLE LT_ZPCZHLYXYFS
      FROM ZPCZHLYXYFS
      FOR ALL ENTRIES IN OT_BKHZ[] WHERE PERNR = OT_BKHZ-PERNR "AND FLAG1 = 2 "2审批完成
      AND BEGDA = L_BEGDA1 AND  ENDDA = L_ENDDA1.
    SORT LT_ZPCZHLYXYFS BY PERNR.

    SELECT * INTO CORRESPONDING FIELDS OF TABLE LT_ZTHR_PCSS_JB FROM ZTHR_PCSS_JB WHERE BEGDA = L_BEGDA1 AND
      OBJID = I_OBJID.


    LOOP AT OT_BKHZ.

      READ TABLE LT_ZPCZHLYXYFS WITH KEY PERNR = OT_BKHZ-PERNR.
      IF  SY-SUBRC = 0.
        L_ZXYFS = LT_ZPCZHLYXYFS-ZXYFS.
        OT_BKHZ-ZXYFS = L_ZXYFS.
      ELSE.
        OT_BKHZ-ZXYFS = '100'.
      ENDIF.
      CLEAR L_ZXYFS.

      READ TABLE LT_ZTHR_PCSS_JB WITH KEY PERNR = OT_BKHZ-PERNR.
      IF SY-SUBRC = 0.
        OT_BKHZ-JBTS = LT_ZTHR_PCSS_JB-JBTS.
      ENDIF.



      MODIFY OT_BKHZ.CLEAR OT_BKHZ.
    ENDLOOP.

*************按部门排序
    DATA: IT_RESULT_STRUC LIKE STRUC OCCURS 0 WITH HEADER LINE.
    DATA: LV_OBJID LIKE HRP1001-OBJID.
    DATA: LV_COUNT TYPE I.
    DATA: LV_LINES TYPE I.
    DESCRIBE TABLE OT_BKHZ LINES LV_LINES.
    IF LV_LINES > 1.

      CALL FUNCTION 'RH_STRUC_GET'
        EXPORTING
          ACT_OTYPE       = 'O'
          ACT_OBJID       = I_OBJID                         "'10001000'
          ACT_WEGID       = 'PERS-O'
          ACT_PLVAR       = '01'
          ACT_BEGDA       = L_BEGDA
          ACT_ENDDA       = L_ENDDA
          ACT_TFLAG       = 'X'
          ACT_VFLAG       = 'X'
          AUTHORITY_CHECK = 'X'
        TABLES
          RESULT_STRUC    = IT_RESULT_STRUC
        EXCEPTIONS
          NO_PLVAR_FOUND  = 1
          NO_ENTRY_FOUND  = 2
          OTHERS          = 3.
      DELETE IT_RESULT_STRUC WHERE OTYPE = 'O'.
      CLEAR LV_COUNT.
      LOOP AT IT_RESULT_STRUC.
        READ TABLE OT_BKHZ WITH KEY PERNR = IT_RESULT_STRUC-OBJID.
        IF SY-SUBRC = 0.
          LV_COUNT = LV_COUNT + 1.
          IT_RESULT_STRUC-SEQNR = LV_COUNT.
          MODIFY IT_RESULT_STRUC.
        ELSE.
          DELETE IT_RESULT_STRUC.
        ENDIF.
      ENDLOOP.

      LOOP AT OT_BKHZ.
        READ TABLE IT_RESULT_STRUC WITH KEY OBJID =  OT_BKHZ-PERNR.
        IF SY-SUBRC = 0.
          OT_BKHZ-ZINX = IT_RESULT_STRUC-SEQNR.
        ELSE.
          OT_BKHZ-ZINX = 99999.
        ENDIF.
        MODIFY OT_BKHZ.CLEAR OT_BKHZ.
      ENDLOOP.
      SORT OT_BKHZ BY ZINX.
    ENDIF.
********************************按部门排序

    LOOP AT OT_BKHZ.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
        EXPORTING
          INPUT  = OT_BKHZ-PERNR
        IMPORTING
          OUTPUT = OT_BKHZ-PERNR.
      MODIFY OT_BKHZ.CLEAR OT_BKHZ.
    ENDLOOP.

    LOOP AT OT_BKHZ.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
        EXPORTING
          INPUT  = OT_BKHZ-ZXYFS
        IMPORTING
          OUTPUT = OT_BKHZ-ZXYFS.
      MODIFY OT_BKHZ.CLEAR OT_BKHZ.
    ENDLOOP.



  ELSEIF I_FLAG = 1.   "个人汇总

*    CLEAR:RESULT_SEARCH,RESULT_SEARCH[].
    SORT  LT_RESULT_SEARCH BY PERNR AWART.
    DATA:SUM TYPE P DECIMALS 2.

    LOOP AT RESULT_SEARCH.
      READ TABLE LT_RESULT_SEARCH WITH KEY PERNR = RESULT_SEARCH-PERNR.
      IF SY-SUBRC = 0.
        DELETE RESULT_SEARCH.
      ENDIF.
    ENDLOOP.

    LOOP AT LT_RESULT_SEARCH.
      MOVE-CORRESPONDING LT_RESULT_SEARCH TO RESULT_SEARCH.
      CONDENSE LT_RESULT_SEARCH-FLAG2.
      SUM = LT_RESULT_SEARCH-FLAG2 + SUM.
      AT END OF AWART.
        RESULT_SEARCH-FLAG2 = SUM.  CLEAR SUM.
        APPEND RESULT_SEARCH.CLEAR RESULT_SEARCH.
      ENDAT.
    ENDLOOP.

    LOOP AT RESULT_SEARCH.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
        EXPORTING
          INPUT  = RESULT_SEARCH-PERNR
        IMPORTING
          OUTPUT = RESULT_SEARCH-PERNR.
      CONDENSE RESULT_SEARCH-FLAG2.
      MODIFY RESULT_SEARCH.CLEAR RESULT_SEARCH.
    ENDLOOP.

  ELSEIF I_FLAG = 2.  "部门汇总

    DATA:BEGIN OF GT_RESULT_SEARCH OCCURS 0,
           OBJID  TYPE HROBJID,
           AWART  LIKE ZHR_PT_KQ01-AWART,
           PERNR  LIKE ZHR_PT_KQ01-PERNR,
           BEGDA  LIKE ZHR_PT_KQ01-BEGDA,
           ENDDA  LIKE ZHR_PT_KQ01-ENDDA,
           NACHN  LIKE ZHR_PT_KQ01-NACHN,
           AGE    LIKE ZHR_PT_KQ01-AGE,
           SEX    LIKE ZHR_PT_KQ01-SEX,
           BUMEN  LIKE ZHR_PT_KQ01-BUMEN,
           ZHIWEI LIKE ZHR_PT_KQ01-ZHIWEI,
           DATA   LIKE ZHR_PT_KQ01-DATA,
           SPRPS  LIKE ZHR_PT_KQ01-SPRPS,
           FLAG1  LIKE ZHR_PT_KQ01-FLAG1,
           FLAG2  LIKE ZHR_PT_KQ01-FLAG2,
           FLAG3  LIKE ZHR_PT_KQ01-FLAG3,
           FLAG4  LIKE ZHR_PT_KQ01-FLAG4,
         END OF GT_RESULT_SEARCH.
    DATA:GT_OBJEC LIKE TABLE OF OBJEC WITH HEADER LINE,
         GT_STRUC LIKE TABLE OF STRUC WITH HEADER LINE.

    DATA:SUM2 TYPE P DECIMALS 2,SUM3 TYPE P DECIMALS 2, SUM4 TYPE P DECIMALS 2.
    DATA:BEGIN OF ITAB OCCURS 0,
           OBJID     TYPE HROBJID,
           STEXT(40),
           NUM       TYPE I,
         END OF ITAB.

    LOOP AT LT_RESULT_SEARCH.
      MOVE-CORRESPONDING LT_RESULT_SEARCH TO LT_RESULT_SEARCH1.
      CONDENSE LT_RESULT_SEARCH-FLAG2.
      SUM2 = LT_RESULT_SEARCH-FLAG2 + SUM2.
      AT END OF AWART.
        LT_RESULT_SEARCH1-FLAG2 = SUM2.  CLEAR SUM2.
        APPEND LT_RESULT_SEARCH1.CLEAR LT_RESULT_SEARCH1.
      ENDAT.
    ENDLOOP.

    DELETE LT_OBJEC WHERE OTYPE <> 'O'.
    LOOP AT LT_OBJEC.
      CLEAR:GT_OBJEC,GT_OBJEC[],GT_STRUC,GT_STRUC[].
      CALL FUNCTION 'RH_STRUC_GET'
        EXPORTING
          ACT_OTYPE      = 'O'
          ACT_OBJID      = LT_OBJEC-OBJID
          ACT_WEGID      = 'PERS-O'
*         ACT_INT_FLAG   =
          ACT_PLVAR      = '01'
          ACT_BEGDA      = I_BEGDA
          ACT_ENDDA      = I_ENDDA
        TABLES
*         RESULT_TAB     =
          RESULT_OBJEC   = GT_OBJEC
          RESULT_STRUC   = GT_STRUC
        EXCEPTIONS
          NO_PLVAR_FOUND = 1
          NO_ENTRY_FOUND = 2
          OTHERS         = 3.
      DELETE GT_STRUC WHERE OTYPE <> 'P'. SORT GT_STRUC BY OBJID.

      LOOP AT LT_RESULT_SEARCH1.
        READ TABLE GT_STRUC WITH KEY OBJID = LT_RESULT_SEARCH1-PERNR OTYPE = 'P'.
        IF SY-SUBRC <> 0.
*          DELETE LT_RESULT_SEARCH1.
        ELSEIF SY-SUBRC = 0.
          LT_RESULT_SEARCH1-FLAG3 = LT_OBJEC-OBJID. "组织单位编码
          LT_RESULT_SEARCH1-FLAG4 = LT_OBJEC-STEXT. "组织单位文本
          MODIFY LT_RESULT_SEARCH1.
          MOVE-CORRESPONDING LT_RESULT_SEARCH1 TO GT_RESULT_SEARCH.
          GT_RESULT_SEARCH-OBJID = LT_RESULT_SEARCH1-FLAG3.
          DESCRIBE TABLE GT_STRUC LINES GT_RESULT_SEARCH-FLAG4.
          APPEND GT_RESULT_SEARCH.CLEAR: GT_RESULT_SEARCH, LT_RESULT_SEARCH1.
        ENDIF.
      ENDLOOP.

      ITAB-OBJID = LT_OBJEC-OBJID. "组织单位编码
      ITAB-STEXT = LT_OBJEC-STEXT. "组织单位文本
      DESCRIBE TABLE GT_STRUC LINES ITAB-NUM.
      APPEND ITAB.CLEAR ITAB.

    ENDLOOP.

    CLEAR:RESULT_SEARCH,RESULT_SEARCH[].
    SORT GT_RESULT_SEARCH BY OBJID AWART.
    LOOP AT GT_RESULT_SEARCH.
      MOVE-CORRESPONDING GT_RESULT_SEARCH TO RESULT_SEARCH.
      CONDENSE GT_RESULT_SEARCH-FLAG2.
      SUM2 = GT_RESULT_SEARCH-FLAG2 + SUM2.
      AT END OF AWART.
        RESULT_SEARCH-FLAG2 = SUM2.  CLEAR SUM2.
        APPEND RESULT_SEARCH.CLEAR RESULT_SEARCH.
      ENDAT.
    ENDLOOP.
    LOOP AT ITAB.
      READ TABLE RESULT_SEARCH WITH KEY FLAG3 = ITAB-OBJID.
      IF SY-SUBRC <> 0.
        CLEAR:RESULT_SEARCH.
        RESULT_SEARCH-FLAG3 = ITAB-OBJID.
        RESULT_SEARCH-FLAG4 = ITAB-NUM.
        APPEND RESULT_SEARCH.CLEAR RESULT_SEARCH.
      ENDIF.
    ENDLOOP.

**********************加班begin
    REFRESH:LT_PA2005[].
    SELECT PERNR BEGDA ENDDA STDAZ VERSL FLAG1 FLAG2 BWGRL INTO CORRESPONDING FIELDS OF TABLE LT_PA2005
      FROM PA2005
      FOR ALL ENTRIES IN RESULT_SEARCH[] WHERE PERNR = RESULT_SEARCH-PERNR AND FLAG1 = 2
      AND BEGDA BETWEEN L_BEGDA AND L_ENDDA AND ENDDA BETWEEN L_BEGDA AND L_ENDDA.
    LOOP AT LT_PA2005.
      RESULT_JB-PERNR = LT_PA2005-PERNR.   "员工编号
      RESULT_JB-BEGDA = LT_PA2005-BEGDA.   "加班日期
      RESULT_JB-STDAZ = LT_PA2005-STDAZ.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
        EXPORTING
          INPUT  = RESULT_JB-PERNR
        IMPORTING
          OUTPUT = RESULT_JB-PERNR.
      APPEND RESULT_JB. CLEAR RESULT_JB.
    ENDLOOP.
***************************加班end
    LOOP AT RESULT_SEARCH.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
        EXPORTING
          INPUT  = RESULT_SEARCH-PERNR
        IMPORTING
          OUTPUT = RESULT_SEARCH-PERNR.
      CONDENSE RESULT_SEARCH-FLAG4.
      CONDENSE RESULT_SEARCH-FLAG2.
      MODIFY RESULT_SEARCH.CLEAR RESULT_SEARCH.
    ENDLOOP.

    LOOP AT RESULT_SEARCH.
      OT_BKHZ-SMON = I_ENDDA+0(6).
      OT_BKHZ-OBJID = I_OBJID.
      OT_BKHZ-STEXT = RESULT_SEARCH-STEXT.
      OT_BKHZ-PERNR = RESULT_SEARCH-PERNR.
      OT_BKHZ-NACHN = RESULT_SEARCH-NACHN.
      OT_BKHZ-ZHIWEI = RESULT_SEARCH-ZHIWEI.
      IF RESULT_SEARCH-AWART = '3010'.
        OT_BKHZ-CD = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART = '3030'.
        OT_BKHZ-KG = RESULT_SEARCH-FLAG2.
      ENDIF.
*****      根据魏芳需求修改由1050改为1210,1060改为1220。修改人李瀚
      IF RESULT_SEARCH-AWART = '1210'.
        OT_BKHZ-CC = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART = '1220'.
        OT_BKHZ-WC = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART = '1230'.
        OT_BKHZ-JAB = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART = '2060'.
        OT_BKHZ-GSJ = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART+0(3) = '200'.
        OT_BKHZ-NJ = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART+0(3) = '201'.
        OT_BKHZ-SJ = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART+0(3) = '202'.
        OT_BKHZ-BJ = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART = '2030'.
        OT_BKHZ-HJ = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART = '2050'.
        OT_BKHZ-CJ = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART = '2051'.
        OT_BKHZ-CJ = RESULT_SEARCH-FLAG2.
      ENDIF.
      IF RESULT_SEARCH-AWART = '2040'.
        OT_BKHZ-SHJ = RESULT_SEARCH-FLAG2.
      ENDIF.
      COLLECT OT_BKHZ.
      CLEAR:OT_BKHZ,RESULT_SEARCH.
    ENDLOOP.

*    LOOP AT OT_BKHZ.
*      LOOP AT RESULT_JB WHERE PERNR = OT_BKHZ-PERNR.
*        OT_BKHZ-JAB = OT_BKHZ-JAB + RESULT_JB-STDAZ.
*        CLEAR:RESULT_JB.
*      ENDLOOP.
*      MODIFY OT_BKHZ.
*      CLEAR OT_BKHZ.
*    ENDLOOP.
  ELSEIF I_FLAG = 3.
*    DATA:YEAR_F LIKE SY-DATUM,YEAR_L LIKE SY-DATUM.
    DATA:L_ANZHL LIKE PA2006-ANZHL,L_KVERB LIKE PA2006-KVERB.
*    CONCATENATE IN_ENDDA+0(4) '0101' INTO YEAR_F.
*    CONCATENATE IN_ENDDA+0(4) '1231' INTO YEAR_L.
    LOOP AT RESULT_SEARCH.
      SELECT SINGLE ANZHL KVERB INTO (L_ANZHL,L_KVERB) FROM PA2006 WHERE
       BEGDA <= I_ENDDA AND ENDDA >= I_ENDDA AND PERNR = RESULT_SEARCH-PERNR AND KTART = '01'.
      RESULT_SEARCH-FLAG2 = L_ANZHL.  "FLAG2 年假定额
      RESULT_SEARCH-FLAG3 = L_ANZHL - L_KVERB. "FLAG3 剩余年假天数
      CLEAR:L_ANZHL,L_KVERB.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
        EXPORTING
          INPUT  = RESULT_SEARCH-PERNR
        IMPORTING
          OUTPUT = RESULT_SEARCH-PERNR.
      CONDENSE:RESULT_SEARCH-FLAG2,RESULT_SEARCH-FLAG3.
      MODIFY RESULT_SEARCH.CLEAR RESULT_SEARCH.
    ENDLOOP.
  ENDIF.

  IF I_FLAG = 2.
    SORT RESULT_SEARCH BY FLAG3.
  ELSE.
    SORT RESULT_SEARCH BY PERNR.
  ENDIF.


*1010	出勤（全天）
*1011	出勤（上午）
*1012	出勤（下午）
*1020	外出公干（全天）
*1021	外出公干（上午）
*1022	外出公干（下午）
*1030	出差（全天）
*1040	培训（全天）
*1041	培训（上午）
*1042	培训（下午）


*2000	年假
*2010	事假（全天）
*2011	事假（上午）
*2012	事假（下午）
*2020	病假（全天）
*2021	病假（上午）
*2022	病假（下午）
*2030	婚假
*2040	丧假
*2050	产假
*2060	工伤假
*2070	流产假
*2080	停工假
*2090	旅游假
*3010	迟到
*3020	早退
*3030	旷工


ENDFUNCTION.
